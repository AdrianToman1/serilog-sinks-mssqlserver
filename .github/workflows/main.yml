name: main

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Run build script
        run: ./Build.ps1

      - name: Get version variable
        run: |
          $selectResult = Select-String -Path ".\src\Serilog.Sinks.MSSqlServer\Serilog.Sinks.MSSqlServer.csproj" -Pattern '<VersionPrefix>(.+)</VersionPrefix>'
          echo ("VERSION=" + $selectResult.Matches[0].Groups[1].Value) >> $env:GITHUB_ENV
          
      - name: Create releease
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "v${{ env.VERSION }}-test"
          prerelease: true
          title: "Release ${{ env.VERSION }}-test"
          files: |
            artifacts\Serilog.Sinks.MSSqlServer.*.nupkg
            artifacts\Serilog.Sinks.MSSqlServer.*.snupkg
